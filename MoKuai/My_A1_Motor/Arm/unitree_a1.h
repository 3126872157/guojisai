#ifndef UNITREE_A1_H
#define UNITREE_A1_H

#include "main.h"
#define Unitree_RX_BUF_NUM 78

extern UART_HandleTypeDef huart6;


#pragma pack(push, 1)

typedef struct
{
    uint8_t	start[2];     // ???
    uint8_t  motorID;      // ???ID  0,1,2,3 ...   0xBB ????????§Ö???????????????
    uint8_t  reserved;
} COMHead;

/////////////////////////////////////------????------////////////////////////////////////////////////////////////////////////////////////////////

// ???? ???????????
typedef struct    // ?? 4???????????? ????????????????
{
    uint8_t  mode;					// ????????
    uint8_t  ModifyBit;			// ?????????????¦Ë
    uint8_t  ReadBit;				// ??????????????¦Ë
    uint8_t  reserved;

    uint32_t  Modify;			// ?????????? ??????
    //????FOC????????????K_P*delta_Pos + K_W*delta_W + T
    int16_t     T;						// ??????????????????????????????x256, 		7 + 8 ????
    int16_t     W;						// ?????????? ??????????????? x128,       	8 + 7????
    int32_t   Pos;					// ???????¦Ë?? x 16384/6.2832, 14¦Ë????????????0????????????????????????0??????

    int16_t    K_P;						// ???????? x2048  4+11 ????
    int16_t    K_W;						// ????????? x1024  5+10 ????

    uint8_t LowHzMotorCmdIndex;     // ????????????????????, 0-7, ??????LowHzMotorCmd?§Ö?8?????
    uint8_t LowHzMotorCmdByte;      // ???????????????????

    uint32_t  Res;    // ?? ???????
} MasterComdV3;

// ???? ????????????????
typedef struct
{
    COMHead 			head;
    MasterComdV3 	Mdata;
    uint32_t   		CRCdata;
} MasterComdDataV3;

// ???? ????????????
typedef struct
{
    MasterComdDataV3  motor_send_data;  //??????????????
    // ??????????????
    unsigned short id;              //???ID??0xBB??????????
    unsigned short mode;            //0:????, 5:???????, 10:???FOC????
    //????FOC????????????K_P*delta_Pos + K_W*delta_W + T
    float T;                        //????????????????????????????????Nm??
    float W;                        //????????????????????????(rad/s)
    float Pos;                      //???????¦Ë???rad??
    float K_P;                      //????????
    float K_W;                      //?????????
} MOTOR_send;


/////////////////////////////////////------????------////////////////////////////////////////////////////////////////////////////////////////////

// ???? ????????
typedef struct    // ?? 4???????????? ????????????????
{
    uint8_t  mode;						// ????????
    uint8_t  ReadBit;					// ?????????????     ?????¦Ë
    int8_t  Temp;							// ????????????
    uint8_t  MError;					// ??????? ???

    int32_t  Read;					// ??????? ??? ?????????
    int16_t     T;						// ???????????????       7 + 8 ????

    int16_t     W;      			// ?????????????????   8 + 7 ????
    float      LW;      			// ?????????????????

    int16_t     W2;      			// ?????????????????   8 + 7 ????
    int32_t      LW2;      			// ?????????????????

    int16_t    Acc;           // ??????????       15+0 ????  ??????§³
    int16_t    OutAcc;        // ?????????         12+3 ????  ???????

    int32_t   Pos;      // ??????¦Ë???????0????????????????????????0??????
    int32_t   Pos2;     // ????????¦Ë??(?????????)

    int16_t     gyro[3];  // ?????????6??????????
    int16_t     acc[3];

    // ??????????????
    int16_t     Fgyro[3];  //
    int16_t     Facc[3];
    int16_t     Fmag[3];
    uint8_t     Ftemp;     // 8¦Ë????????  7¦Ë??-28~100???  1¦Ë0.5??????

    int16_t     Force16;   // ??????????16¦Ë????
    int8_t      Force8;    // ??????????8¦Ë????

    uint8_t     FError;    //  ??????????????

    int8_t      Res;    // ?? ???????

} ServoComdV3; // ????????????? ??CRC 78????4+70+4??


// ???? ????????????
typedef struct
{
    COMHead				head;
    ServoComdV3		Mdata;
    uint32_t    	CRCdata;
} ServoComdDataV3;	//????????


// ???? ?????????????
typedef struct
{
    unsigned char motor_id;         //???ID
    unsigned char mode;             //0:????, 5:???????, 10:???FOC????
    int Temp;                       //???
    unsigned char MError;           //??????

    float T;                        // ???????????????
    float W;                        // ?????????????????
    float LW;                       // ?????????????????
    float Acc;                      	// ??????????
    float Pos;                      // ??????¦Ë???????0????????????????????????0??????

    float gyro[3];                  // ?????????6??????????
    float acc[3];
} MOTOR_recv;

#pragma pack(pop)


union Fp32
{
    uint32_t u;
    float f;
};

extern UART_HandleTypeDef huart6;
extern DMA_HandleTypeDef hdma_usart6_rx;
extern DMA_HandleTypeDef hdma_usart6_tx;

extern uint8_t Unitree_rx6_buf[][Unitree_RX_BUF_NUM];
extern ServoComdDataV3 motor_data_rx6;


uint32_t crc32_core(uint32_t* ptr, uint32_t len);

//???????????
void Unitree_Usart6_Init(uint8_t *rx1_buf, uint8_t *rx2_buf, uint16_t dma_buf_num);
//?????????
void ModifyData(MOTOR_send* motor_s,uint8_t ID,uint8_t MODE,float Torque, float W, float POS, float KP, float KW);
//??????????????
void UnitreeSend(MOTOR_send* motor);
//??????????????
void ExtractData(MOTOR_recv* motor_r, ServoComdDataV3* data_rx);
//§µ????????????????????????
void data_rx_copy(ServoComdDataV3*motor_data_rx, uint8_t* data);
//???????????
void unitree_move(uint8_t flag,float pos,float w);

void USART6_IRQHandler_1(void);

void USART6_IRQHandler_1(void);
#endif
